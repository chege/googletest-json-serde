version: '3'
silent: true

tasks:
  default:
    desc: List all available tasks
    cmds:
      - task --list
    silent: false

  verify:
    desc: Run all checks equivalent to CI
    cmds:
      - echo "ğŸ§¹ Checking formatting..."
      - cargo fmt --all -- --check

      - echo "ğŸ” Running Clippy (stable)..."
      - cargo clippy --workspace --all-targets --all-features -- -D warnings

      - echo "ğŸ§ª Running tests..."
      - |
        if command -v cargo-nextest >/dev/null 2>&1; then
          cargo nextest run --all-features \
            --hide-progress-bar \
            --failure-output=immediate \
            --success-output=never \
            --status-level=fail
          cargo test --doc --all-features --quiet
        else
          cargo test --all-features --quiet
        fi
    silent: false

  fix:
    desc: Auto-fix formatting and Clippy issues, then run tests
    cmds:
      - echo "ğŸ§¹ Fixing formatting..."
      - cargo fmt --all

      - echo "ğŸ”§ Running Clippy with autofix..."
      - cargo clippy --workspace --all-targets --all-features --fix --allow-dirty --allow-staged -- -D warnings

      - echo "ğŸ§ª Running tests..."
      - |
        if command -v cargo-nextest >/dev/null 2>&1; then
          cargo nextest run --all-features \
            --hide-progress-bar \
            --failure-output=immediate \
            --success-output=never \
            --status-level=fail
          cargo test --doc --all-features --quiet
        else
          cargo test --all-features --quiet
        fi
    silent: false

  test-all:
    desc: Run all tests (unit, integration, ignored, and doctests)
    cmds:
      - echo "ğŸ§ª Running unit/integration tests..."
      - cargo test --all-features --quiet

      - echo "ğŸ§ª Running ignored tests..."
      - cargo test --all-features --quiet -- --ignored

      - echo "ğŸ§ª Running doctests..."
      - cargo test --doc --all-features --quiet
    silent: false

  coverage:
    desc: Run tests and report code coverage (requires cargo-llvm-cov)
    cmds:
      - echo "ğŸ§ª Running coverage (threshold 90%)..."
      - cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info --fail-under-lines 90

  open-coverage:
    desc: Open the interactive HTML coverage report
    cmds:
      - echo "ğŸ–¥ï¸ Generating and opening HTML report..."
      - cargo llvm-cov --all-features --workspace --html --open
